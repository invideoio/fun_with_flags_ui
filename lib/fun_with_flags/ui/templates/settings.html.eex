<!DOCTYPE html>
<html lang="en">
  <%= _head(conn: @conn, title: "Settings") %>
  <body>
    <nav id="fwf-top-bar" class="navbar navbar-inverse navbar-toggleable-xl">
      <a class="navbar-brand" href="https://github.com/tompave/fun_with_flags">FunWithFlags</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="<%= path(@conn, "/flags") %>">all flags</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="">settings</a>
          </li>
        </ul>

        <a href="<%= path(@conn, "/new") %>" class="btn btn-secondary">New Flag</a>
      </div>
    </nav>

    <div class="container mt-3">
      <h1>Settings</h1>

      <%= if Map.get(assigns, :success_message) do %>
        <div class="alert alert-success alert-dismissible" role="alert">
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <%= html_escape(@success_message) %>
        </div>
      <% end %>

      <%= if Map.get(assigns, :error_message) do %>
        <div class="alert alert-danger" role="alert">
          <%= html_escape(@error_message) %>
        </div>
      <% end %>

      <!-- Export Section -->
      <div class="card mt-4">
        <div class="card-header">
          <h3>Export Flags</h3>
        </div>
        <div class="card-body">
          <p>
            Download all feature flags with their gates as a binary file.
            The file can be imported later to restore flags.
          </p>
          <p class="text-muted">
            <small>File format: Erlang Term Format (.etf)</small>
          </p>

          <form action="<%= path(@conn, "/settings/export") %>" method="post">
            <input type="hidden" name="_csrf_token" value="<%= @conn.assigns[:csrf_token] %>">
            <button type="submit" class="btn btn-primary">
              <span class="glyphicon glyphicon-download-alt"></span>
              Export All Flags
            </button>
          </form>
        </div>
      </div>

      <!-- Import Section -->
      <div class="card mt-4">
        <div class="card-header">
          <h3>Import Flags</h3>
        </div>
        <div class="card-body">
          <%= if Map.get(assigns, :import_error_message) do %>
            <div class="alert alert-danger" role="alert">
              <strong>Import failed:</strong> <%= html_escape(@import_error_message) %>
            </div>
          <% end %>

          <p>
            Upload a flags export file (.etf) to restore feature flags.
          </p>

          <%= if @import_disabled do %>
            <div class="alert alert-warning" role="alert">
              Import is disabled in production.
            </div>
          <% end %>

          <form action="<%= path(@conn, "/settings/import") %>"
                method="post"
                enctype="multipart/form-data">
            <input type="hidden" name="_csrf_token" value="<%= @conn.assigns[:csrf_token] %>">

            <div class="form-group">
              <label for="file">Select File</label>
              <input type="file"
                     class="form-control"
                     id="file"
                     name="file"
                     accept=".etf"
                     required
                     <%= if @import_disabled, do: "disabled" %>>
              <small class="form-text text-muted">
                Maximum file size: 10 MB. Maximum flags: 10,000.
              </small>
            </div>

            <div class="form-group">
              <label>Import Mode</label>

              <div class="form-check" style="padding-left: 0;">
                <label class="form-check-label" for="mode-overwrite" style="display: inline-flex; align-items: flex-start; gap: 8px;">
                  <input class="form-check-input" type="radio" name="mode" value="overwrite" id="mode-overwrite" checked style="margin-top: 2px;" <%= if @import_disabled, do: "disabled" %>>
                  <span>
                    <strong>Import and Overwrite</strong>
                    <br>
                    <small class="text-muted">
                      Import flags from the file. Existing flags with the same name
                      will be overwritten. Other flags remain unchanged.
                    </small>
                  </span>
                </label>
              </div>

              <div class="form-check mt-2" style="padding-left: 0;">
                <label class="form-check-label" for="mode-clear" style="display: inline-flex; align-items: flex-start; gap: 8px;">
                  <input class="form-check-input" type="radio" name="mode" value="clear" id="mode-clear" style="margin-top: 2px;" <%= if @import_disabled, do: "disabled" %>>
                  <span>
                    <strong>Clear and Import</strong>
                    <span class="text-danger">(Destructive!)</span>
                    <br>
                    <small class="text-muted">
                      Delete ALL existing flags first, then import.
                      Use this to completely replace your flags with the import file.
                    </small>
                  </span>
                </label>
              </div>
            </div>

            <button type="submit" class="btn btn-primary" <%= if @import_disabled, do: "disabled" %>>
              <span class="glyphicon glyphicon-upload"></span>
              Import Flags
            </button>
          </form>
        </div>
      </div>

      <!-- Documentation Section -->
      <div class="card mt-4 mb-4">
        <div class="card-header bg-info text-white">
          <h3>About Import/Export</h3>
        </div>
        <div class="card-body">
          <h4>Use Cases</h4>
          <ul>
            <li><strong>Backup:</strong> Regular exports for disaster recovery</li>
            <li><strong>Migration:</strong> Move flags between environments</li>
            <li><strong>Versioning:</strong> Save flag configurations at specific points in time</li>
          </ul>

          <h4>Safety Features</h4>
          <ul>
            <li>All imports are atomic (all-or-nothing)</li>
            <li>File validation prevents corrupted data</li>
            <li>Maximum limits prevent resource exhaustion</li>
            <li>Audit events logged via telemetry</li>
          </ul>

          <h4>File Format</h4>
          <p>
            Export files use Erlang Term Format (.etf), a binary format native to
            Elixir/Erlang. This ensures type safety and compatibility across versions.
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
